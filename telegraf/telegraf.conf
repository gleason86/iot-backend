# Telegraf Configuration
# IoT Backend - MQTT to InfluxDB Pipeline

# =============================================================================
# Global Agent Configuration
# =============================================================================

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = "iot-telegraf"
  omit_hostname = false

# =============================================================================
# Output: InfluxDB v2
# =============================================================================

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUXDB_TOKEN}"
  organization = "${INFLUXDB_ORG}"
  bucket = "${INFLUXDB_BUCKET}"

# =============================================================================
# Input: MQTT Consumer
# =============================================================================

[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  
  # Subscribe to all IoT sensor topics
  topics = [
    "iot/sensors/+/data",
    "iot/sensors/+/status"
  ]
  
  # Authentication
  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"
  
  # Data format
  data_format = "json_v2"
  
  # QoS level (1 = at least once delivery)
  qos = 1
  
  # Client ID
  client_id = "telegraf-iot-collector"
  
  # Parse JSON payload
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "sensor_data"
    
    # Extract device_id from topic: iot/sensors/{device_id}/data
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "device_id"
      type = "string"
    
    # Temperature readings
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "temperature_f"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "temperature_c"
      type = "float"
      optional = true
    
    # Humidity
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "humidity"
      type = "float"
      optional = true
    
    # Dew point
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "dew_point_f"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "dew_point_c"
      type = "float"
      optional = true
    
    # Motion sensor
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "motion"
      type = "boolean"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "motion_count"
      type = "int"
      optional = true
    
    # Device uptime
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "uptime_ms"
      type = "int"
      optional = true
    
    # Min/Max values
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "temp_min_f"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "temp_max_f"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "humidity_min"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "humidity_max"
      type = "float"
      optional = true
    
    # Status fields
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "status"
      type = "string"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "ip"
      type = "string"
      optional = true


