# IoT Backend - Cursor Agent Rules
# Ensures data consistency across the entire IoT pipeline

## Project Architecture

This project is an IoT data pipeline with the following components:

```
┌─────────────────┐     ┌───────────────┐     ┌──────────────┐     ┌───────────────┐     ┌───────────────┐
│  Arduino/IoT    │────▶│   Mosquitto   │────▶│   Telegraf   │────▶│   InfluxDB    │────▶│    Grafana    │
│    Devices      │     │  MQTT Broker  │     │   Pipeline   │     │   Database    │     │  Dashboards   │
└─────────────────┘     └───────────────┘     └──────────────┘     └───────────────┘     └───────────────┘
     (upstream)                                                                              (downstream)
```

### Component Locations
- **IoT Device Code**: `../Arduino/` (separate repo, referenced for schema)
- **MQTT Broker**: `mosquitto/mosquitto.conf`
- **Data Pipeline**: `telegraf/telegraf.conf`
- **Database**: InfluxDB (config via docker-compose.yml environment)
- **Dashboards**: `grafana/dashboards/*.json`
- **Infrastructure**: `docker-compose.yml`

---

## Data Schema Definition

The canonical sensor data schema (JSON payload from IoT devices):

```json
{
  "device_id": "string",           // Tag: Device identifier
  "temperature_c": "float",        // Field: Temperature in Celsius
  "temperature_f": "float",        // Field: Temperature in Fahrenheit
  "humidity": "float",             // Field: Relative humidity (%)
  "dew_point_c": "float",          // Field: Dew point in Celsius
  "dew_point_f": "float",          // Field: Dew point in Fahrenheit
  "motion": "boolean",             // Field: Motion detected flag
  "motion_count": "int",           // Field: Motion event count per interval
  "uptime_ms": "int",              // Field: Device uptime in milliseconds
  "temp_min_f": "float",           // Field: Session minimum temperature (F)
  "temp_max_f": "float",           // Field: Session maximum temperature (F)
  "humidity_min": "float",         // Field: Session minimum humidity
  "humidity_max": "float",         // Field: Session maximum humidity
  "status": "string",              // Field: Device status (online/offline)
  "ip": "string"                   // Field: Device IP address
}
```

### MQTT Topics
- Data: `iot/sensors/{device_id}/data`
- Status: `iot/sensors/{device_id}/status`

### InfluxDB Schema
- **Measurement**: `sensor_data`
- **Tags**: `device_id`
- **Fields**: All sensor data fields listed above

---

## Critical Rules for Data Changes

### Rule 1: Adding a New Sensor Field

When adding a new field to the IoT data payload:

1. **Update Telegraf config** (`telegraf/telegraf.conf`):
   - Add a new `[[inputs.mqtt_consumer.json_v2.field]]` block
   - Specify correct `path`, `type`, and set `optional = true`

2. **Update Grafana dashboard** (`grafana/dashboards/iot-sensors.json`):
   - Add visualization panel(s) for the new field
   - Use appropriate Flux query filtering by `r._field == "new_field_name"`
   - Choose correct unit type and visualization style

3. **Document the change** in `CHANGELOG.md`

**Example - Adding a `light_level` field:**
```toml
# In telegraf/telegraf.conf
[[inputs.mqtt_consumer.json_v2.field]]
  path = "light_level"
  type = "int"
  optional = true
```

### Rule 2: Removing a Sensor Field

When removing a field from the IoT data:

1. **Update Telegraf config**: Remove or comment out the field definition
2. **Update Grafana dashboards**: Remove any panels/queries referencing the field
3. **Note**: Historical data in InfluxDB will remain; no DB changes needed

### Rule 3: Renaming a Sensor Field

When renaming a field:

1. **Update Telegraf config**: Change the `path` value to match new field name
2. **Update all Grafana queries**: Search for old field name in dashboard JSON
3. **Consider migration**: Old data will use old field name; new data uses new name

### Rule 4: Changing Field Data Type

When changing a field's data type:

1. **Update Telegraf config**: Change the `type` value (float, int, boolean, string)
2. **Update Grafana panels**: Ensure visualization supports new type
3. **Warning**: Type changes may cause InfluxDB conflicts with existing data

### Rule 5: Adding a New MQTT Topic

When subscribing to new MQTT topics:

1. **Update Telegraf config**: Add topic to `topics` array
2. **Consider**: May need separate `[[inputs.mqtt_consumer.json_v2]]` block for different schema

### Rule 6: Adding a New Tag (Dimension)

When adding a new tag for data grouping:

1. **Update Telegraf config**: Add `[[inputs.mqtt_consumer.json_v2.tag]]` block
2. **Update Grafana**: Add template variable for filtering by new tag
3. **Update dashboard queries**: Include tag in `filter()` or `group()` clauses

---

## File-Specific Guidelines

### telegraf/telegraf.conf
- Each JSON field from IoT devices must have a corresponding field definition
- Use `optional = true` for all fields (devices may not send all fields)
- Tags are indexed; use sparingly (device_id, location, etc.)
- Fields are not indexed; use for measurements (temperature, humidity, etc.)

### grafana/dashboards/*.json
- All panels querying sensor data must use measurement `sensor_data`
- Use template variable `${device:regex}` for device filtering
- Queries should use `aggregateWindow()` for time-series panels
- Use consistent color schemes across related metrics

### docker-compose.yml
- Environment variables for credentials use `.env` file
- Volume mounts for config files should be read-only (`:ro`)
- Service dependencies must reflect data flow order

---

## Validation Checklist

Before committing changes that affect data structure:

- [ ] Telegraf config has field definition for all IoT payload fields
- [ ] Field types match between IoT device code and Telegraf config
- [ ] Grafana dashboards can query all stored fields
- [ ] No orphaned dashboard panels querying removed fields
- [ ] CHANGELOG.md updated with schema changes
- [ ] Restart containers to apply config changes: `docker-compose restart telegraf grafana`

---

## Common Flux Query Patterns

### Query a specific field
```flux
from(bucket: "iot")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r._measurement == "sensor_data")
  |> filter(fn: (r) => r._field == "temperature_f")
  |> filter(fn: (r) => r.device_id =~ /${device:regex}/)
```

### Get latest value
```flux
from(bucket: "iot")
  |> range(start: -5m)
  |> filter(fn: (r) => r._measurement == "sensor_data")
  |> filter(fn: (r) => r._field == "humidity")
  |> last()
```

### Aggregate for time-series
```flux
from(bucket: "iot")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r._measurement == "sensor_data")
  |> filter(fn: (r) => r._field == "dew_point_f")
  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
```

---

## Cross-Reference: IoT Device Fields

The Arduino sketch (`../Arduino/DHT20_OLED/DHT20_OLED.ino`) publishes:

| Field | Type | Description | Telegraf | Grafana Panel |
|-------|------|-------------|----------|---------------|
| device_id | string | Device identifier | Tag | Variable filter |
| temperature_f | float | Temperature (°F) | Field | Temperature chart, gauge |
| temperature_c | float | Temperature (°C) | Field | (available) |
| humidity | float | Relative humidity % | Field | Humidity chart, gauge |
| dew_point_f | float | Dew point (°F) | Field | Dew Point chart |
| dew_point_c | float | Dew point (°C) | Field | (available) |
| motion | boolean | Motion detected | Field | Motion Status stat |
| motion_count | int | Events per interval | Field | Motion Count bar chart |
| uptime_ms | int | Device uptime | Field | (available) |
| temp_min_f | float | Session min temp | Field | (available) |
| temp_max_f | float | Session max temp | Field | (available) |
| humidity_min | float | Session min humidity | Field | (available) |
| humidity_max | float | Session max humidity | Field | (available) |
| status | string | online/offline | Field | (available) |
| ip | string | Device IP | Field | (available) |

---

## Quick Commands

```powershell
# Restart services after config changes
docker-compose restart telegraf grafana

# View Telegraf logs for parsing errors
docker-compose logs -f telegraf

# Test MQTT message manually
mosquitto_pub -h localhost -p 1883 -u $MQTT_USER -P $MQTT_PASSWORD -t "iot/sensors/test/data" -m '{"device_id":"test","temperature_f":72.5,"humidity":45.0}'

# Query InfluxDB directly
docker-compose exec influxdb influx query 'from(bucket:"iot") |> range(start:-1h) |> limit(n:10)'
```

---

## Security Best Practices

### Rule: Never Hardcode Secrets

**CRITICAL**: Never hardcode credentials, tokens, passwords, API keys, or other sensitive values directly in configuration files or code.

- Use environment variables (e.g., `${VARIABLE_NAME}` or `$VARIABLE_NAME`)
- Reference secrets from `.env` file which is gitignored
- Use Docker secrets or external secret management for production

**Bad Example:**
```yaml
# NEVER DO THIS
token: my-super-secret-token-12345
password: admin123
```

**Good Example:**
```yaml
# Always use environment variable references
token: ${INFLUXDB_ADMIN_TOKEN}
password: ${MQTT_PASSWORD}
```

### Rule: Provide Example Files for Gitignored Configs

When a configuration file must be gitignored (because it contains local settings or secrets):

1. Create a `.example` version with placeholder values
2. Document how to create the actual file from the example
3. Include comments explaining each configuration option

**Pattern:**
- `config.yml` → gitignored (actual config with secrets)
- `config.yml.example` → committed (template with placeholders)

### Rule: Sensitive Data Patterns to Avoid Committing

Before committing, review files for these patterns:
- Passwords and tokens
- API keys and secrets
- Internal IP addresses and hostnames
- Personal email addresses or usernames
- Database connection strings with credentials
- Private keys and certificates

### Rule: Environment Variable Naming

Use consistent naming for environment variables:
- `SERVICE_ADMIN_USER` - Admin username
- `SERVICE_ADMIN_PASSWORD` - Admin password
- `SERVICE_ADMIN_TOKEN` - API token or auth token
- `SERVICE_HOST` - Service hostname
- `SERVICE_PORT` - Service port

### Rule: Review Before Public Sharing

Before pushing to a public repository or sharing code:

1. Run `git diff --cached` to review staged changes
2. Search for common secret patterns: `password`, `token`, `secret`, `key`, `credential`
3. Verify all `.env` and password files are gitignored
4. Check that no internal network information is exposed
5. Ensure example files only contain placeholder values

### Sensitive Files in This Project

| File | Status | Contains |
|------|--------|----------|
| `.env` | Gitignored | All service credentials |
| `mosquitto/password.txt` | Gitignored | MQTT user credentials (hashed) |
| `env.example.txt` | Committed | Template with placeholder values |
| `mosquitto/password.txt.example` | Committed | Instructions only |

